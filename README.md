# Circuit Bot

Project to aid in sending status messages to Unify's Circuit. It is really straight-forward and is quick and easy to set up.

# Setup

All the internal dependencies are not available publicly, so you should add your bot to this monolithic repo, albeit this project is not developed as a monolithic tree.
Updates are just a pulling and rebasing (or merging; whatever you prefer) upstream.

Monolithic repo (mono-repo) in this case means that all modules of the project are in one repository. Not using an monolithic tree (mono-tree) means that the modules are still in their own distinct folders.

# Paradigms

- Everything in this project is designed to work auto-magically.
- rather non-oop, rather imperative, functional style
- do not repeat yourself
- do not check-in generated code.

# Theoretical Architecture

 - Bot: Instance of the bot implementation provided by this project
 - Plugin: Implemenatation for providing and/or processing status messages
 - Wakeup: Event that wakes up the bot or a plugin
    - (In)Direct: When the bot wakeup event represents a (no) status
 - Trigger: Changes plugin behaviour (TODO)

A Bot has plugins.

A Bot receives wakeups.

Wakeups have at least one trigger. (TODO)

Plugins receive wakeups from their corresponding bot.

Plugins may change their behaviour based on the presence of a trigger (e.g. whether they are enabled). (TODO)

# Genereal Requirements

 - PHP 5.3+
 - Composer
    - I do not recommend to use the curl-pipe command from getcomposer.org, use your distributions package manager instead. Package should be named `composer`.<br>
     (RHEL7: Make sure the `optional` repo is activated: `subscription-manager repos --enable=rhel-7-server-optional-rpms`)
 - fetch-api-client.sh
    - It's required to execute this to fetch the Client for the Circuit API. (Using it's Swagger definition and generator.swagger.io.)
    - You also can generate it yourself using the `swagger-generator-cli.jar`, just pass the `circuit-client-gen-conf.json` as the configuration. The resulting client must reside in `circuit-api`.

# Bots

## Create a Bot

Your bot should live in it's own directory. The name should start with `circuit-bot-`.

Automating this is todo.

 - create a dirctory for the bot and enter it
 - copy the `composer.json.bot-example` and `config.php.example` to `composer.json` and `config.php` inside your directory
     - in `composer.json`: Edit name, description and author, but leave everything else unchanged.
     - in `config.php`   : Insert your OAuth Client ID and Secret. Insert the conversation ID of the conversation the messages should appear in. (See Q&A below how to get it.)
 - `composer install` to install the dependencies.
 - Your bot is now ready!

# Plugins

## Installing plugins

Just require them!

For all the plugins the name is the same as the directory they reside in, prefixed with `ciis0/`.

    composer require ciis0/circuit-bot-plugin-ex

You meight need to add configurations for those plugins to your `config.php`. Consult their README!

E.g. in this case you would need to add `$config['parent_id']`, which is the ID of an item to reply to.
For more information head over to [circuit-bot-plugin-ex/README.html](circuit-bot-plugin-ex/README.html)! <!-- or .md, if you are browsing the .md files. -->

Adding those values interactively is a todo.

## Creating plugins

### Plugin "API"

The Plugin "API" is based on Hooks, like in Wordpress, consisting of filters and actions.

Filters are two-way, they are passed a value and return a value.
Actions are one-way, they are passed a value but cannot return a value.

But first a quick digression to Circuit conversations.

 - Conversations consist of items (messages)
 - Each item has an ID
 - Items can have a parent (message replies). If an item already has a parent, it cannot be a parent item.

And now: Ducks.

The API can send messages and message replies.
If you only want to send messages, you meight use the `wakeup` filter. If you also want to send replies, use the `wakup_advanced` filter.

The filters are passed an array which they can append messages to. For the `wakeup` filter those are strings, for `wakup_advanced` `AdvancedMessage` objects.

An `AdvancedMessage` is a simple container for a message, message ID and a parent ID.
The message ID is a runtime-unique ID for the message. It is generated by the container's constructor.
The parent ID is the ID of the item to respond to, you meight not know one yet so it can be unset.
Keep reading for how to get a parent ID.

The `parent_id` action is called after a message with an unset parent id was sent.
It is called with the ID of that message and the item ID it now has.

Your plugin cannot read messages from the conversation, so you will have to keep track of the messages you sent and meight want to reply to later. (e.g. sending "server x is down" and later replying "server x is still down!".)

`wakup_advanced`, `parent_id` and `AdvancedMessage` general flow (simplified; m: message, p: parent item ID, id: message id):

```
            | Bot |                     | Plugin
- wakeup -->|     |                     |
            |     |-- wakup_advanced -->|
            |     |                     |
            |     |<--------------------|
            |     |     {               |
            |     |       m : "..."     |
            |     |       p : null      |
            |     |       id: 0         |
            |     |     }               |
            |     |                     |
<- m: "..."-|     |                     |
            |     |                     |
- 1b ------>|     |                     |
            |     |                     |
            |     |-- parent_id ------->|
            |     |   id:0, p: 1b       |
            |     |                     |
```

### Create

Like creating a bot, but name should start with `circuit-plugin-`.

 - create a directory for your plugin and enter it
 - copy `composer.json.plg-example` to `composer.json` in your directory
    - Edit name, description and author. Leave everything else unchanged.
 - create an index.php (this file will be auto-loaded by Composer)
    - you _must not_ require Composer's autoloader (`vendor/autoload.php`) in your `index.php`, the bot will do that for you.
    - your plugin meight be included multiple times, use `function_exists` and similar means to prevent redefinitions. (Hint: require_once does not help.)

 If you want to test your plugin, create a `test.php` (call it what ever you like) and require the autoloader and your `index.php` there. :)

You are now ready to develop your plugin!

Using hooks:

    global $hooks;

    // attach to action
    // callback is the name of the callback function
    $hooks->add_filter($action_name, $callback);

    // attach to filter
    $hooks->add_filter($filter_name, $callback);

    // Due to the library we use for the hooks, callbacks are by default only passed a single parameter.
    // To receive more you have to add it to the add_filter/add_action call, but there is a fourth parameter
    // you need to set: the priority. Unless you know what your are doing, keep it at 10 (the default value).
    $hooks->add_action($filter_name, $callback, 10 /* priority */, $num_args);

    // example action with 2 args

    $hooks->add_action('parent_id', 'my_parent_id_callback', 10, 2);

    function my_parent_id_callback($msg_id, $parent_id)
    {

        // do work with $msg_id and $parent_id

        // remember actions returns do nothing
        // but also remember filters always need a return

    }

For testing without a bot, require `bainternet/php-hooks` (which is the library we use for hooks) as a dev-dependency. You then can exectue the hooks yourself.

    // in your test.php

    $global hooks;

    // Execute action
    $hooks->do_action('action_name', $arg);

    // Execute filters
    $result = $hooks->apply_filters('filter_name', $arg);

# Q&A

**Q**: Conversation ID<br>
**A**: Goto Circuit, right-click the converstation, copy link to conversation. Everything behind the last `/` is the ID.<br>
Example: The link of the SDK Support Group is `https://eu.yourcircuit.com/#/conversation/119dd505-06f3-4848-ad4d-325724519c2e`, the ID then is `119dd505-06f3-4848-ad4d-325724519c2e`.

# Author

Christoph Schulz, <christoph.2.schulz@atos.net>

September 2017.
